<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Case Studies · Dar_One</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../getting_started/">Dar_One</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../getting_started/">Getting Started</a></li><li><a class="tocitem" href="../beginner_tutorials/">Beginner Tutorials</a></li><li class="is-active"><a class="tocitem" href>Case Studies</a><ul class="internal"><li class="toplevel"><a class="tocitem" href="#Before-you-begin"><span>Before you begin</span></a></li><li class="toplevel"><a class="tocitem" href="#Case-Study-A-Bottle-Experiment"><span>Case Study A - Bottle Experiment</span></a></li><li><a class="tocitem" href="#Overview"><span>Overview</span></a></li><li><a class="tocitem" href="#Code-Walkthrough"><span>Code Walkthrough</span></a></li><li><a class="tocitem" href="#Output"><span>Output</span></a></li><li class="toplevel"><a class="tocitem" href="#Case-Study-B-Global-Steady-State"><span>Case Study B - Global Steady State</span></a></li><li><a class="tocitem" href="#Overview-2"><span>Overview</span></a></li><li><a class="tocitem" href="#Code-Walkthrough-2"><span>Code Walkthrough</span></a></li><li class="toplevel"><a class="tocitem" href="#Case-Study-C-Nitrogen-Fixers-Niche"><span>Case Study C - Nitrogen Fixers Niche</span></a></li><li><a class="tocitem" href="#Overview-3"><span>Overview</span></a></li><li><a class="tocitem" href="#Code-Walkthrough-3"><span>Code Walkthrough</span></a></li><li><a class="tocitem" href="#Output-2"><span>Output</span></a></li></ul></li><li><a class="tocitem" href="../">Modify Parameters</a></li><li><a class="tocitem" href="../all_docs/">All Documentation</a></li><li><a class="tocitem" href="../darwin_background/">Darwin Background</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Case Studies</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Case Studies</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/barbara42/Dar_One/blob/main/docs/src/case_studies.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Case-Studies"><a class="docs-heading-anchor" href="#Case-Studies">Case Studies</a><a id="Case-Studies-1"></a><a class="docs-heading-anchor-permalink" href="#Case-Studies" title="Permalink"></a></h1><p>A step by step guide to the code for the three case studies presented in our paper (to come). </p><p>Contents </p><ul><li><a href="#Case-Study-A-Bottle-Experiment">Bottle Experiment</a></li><li><a href="#Case-Study-B-Global-Steady-State">Global Steady state</a></li><li><a href="#Case-Study-C-Nitrogen-Fixers-Niche">Nitrogen Fixers Niche</a></li></ul><h1 id="Before-you-begin"><a class="docs-heading-anchor" href="#Before-you-begin">Before you begin</a><a id="Before-you-begin-1"></a><a class="docs-heading-anchor-permalink" href="#Before-you-begin" title="Permalink"></a></h1><p>If you haven&#39;t already, follow the <a href="https://barbara42.github.io/Dar_One/build/getting_started/">getting started</a> instructions, which will guide you through installation, general program structure, and workflow. </p><p>This guide to the case studies assumes you are using docker or otherwise working from a command line. If you would rather have a graphical interface, you can use the <a href="https://code.visualstudio.com/docs/containers/overview">Docker extension in VS Code</a>. </p><p>For each case study, there is a build file and a run file. These instructions will have you open each file, explain the contents, then close it and execute it with the <code>julia</code> command from the command line. </p><p>If you are using the docker, you can find the code for the case students in the <code>/dar_one_docker/Dar_One/case_studies</code> directory. </p><pre><code class="language-bash hljs">cd /dar_one_docker/Dar_One/case_studies
ls</code></pre><p>You should see the following six files listed. </p><pre><code class="nohighlight hljs">bottle_experiment_build.jl
bottle_experiment_run.jl
global_steadystate_build.jl
global_steadystate_run.jl
nitrogen_fixers_run.jl
nitrogen_fixers_build.jl</code></pre><p>You can also find the code on github <a href="https://github.com/barbara42/Dar_One/tree/main/case_studies">here</a>. </p><p>Each case study has a file to build the Darwin model and a file to run it. As explained in the getting started document, you only need to run the build step when making structural changes to your experiments -  such as a new grid size, setting ambient nutrients to be constant or cycling, or a new number of plankton tracers. After building once, you can change other parameters from run to run without building again - such as nutrient levels, plankton abundances, temperature, and light. </p><h1 id="Case-Study-A-Bottle-Experiment"><a class="docs-heading-anchor" href="#Case-Study-A-Bottle-Experiment">Case Study A - Bottle Experiment</a><a id="Case-Study-A-Bottle-Experiment-1"></a><a class="docs-heading-anchor-permalink" href="#Case-Study-A-Bottle-Experiment" title="Permalink"></a></h1><p>A simple nutrient amendment experiment. What happens if we take a plankton community that is nitrogen limited and add nitrogen? </p><h2 id="Overview"><a class="docs-heading-anchor" href="#Overview">Overview</a><a id="Overview-1"></a><a class="docs-heading-anchor-permalink" href="#Overview" title="Permalink"></a></h2><p>In this experiment, DAR1 is initialized with values from a global DARWIN run. Initial parameter values were taken from location X=203 and Y=108 (lon = 203.5, lat = 28.5). In the control run, nothing was modified. For the bottle experiment run, nitrate values were increased 10x. </p><p><img src="../images/bottle_experiment.png" alt="bottle experiment"/></p><p>The initial parameters that were set include all nutrient tracers (TRAC01-TRAC20), all biomass tracers excluding diazotrophs (TRAC21-TRAC29, TRAC35-TRAC70), PAR at a depth of 45m, and temperature. It was set to run for 7 days (56 iterations), writing to diagnostic files every 4 hours (14400 seconds). Reminder that you can find a list of all nutrient and plankton tracers in  <a href="https://barbara42.github.io/Dar_One/build/darwin_background/">Darwin background</a></p><h2 id="Code-Walkthrough"><a class="docs-heading-anchor" href="#Code-Walkthrough">Code Walkthrough</a><a id="Code-Walkthrough-1"></a><a class="docs-heading-anchor-permalink" href="#Code-Walkthrough" title="Permalink"></a></h2><p>From the Docker command line, we can open up the bottle<em>experiment</em>build.jl file using the following command</p><pre><code class="language-bash hljs">vim bottle_experiment_build.jl</code></pre><p>Reminder that we are in the <code>/dar_one_docker/Dar_One/case_studies</code> directory. Use the arrow keys to navigate the cursor around with vim, <code>i</code> to enter insert mode, <code>esc</code> to exit the mode, and <code>:q</code> to close the file. We will walk through all the code in this file before running it. </p><p>You will see these lines of code at the top of the file. </p><pre><code class="nohighlight hljs">include(&quot;../src/DarOneTools.jl&quot;)
using .DarOneTools
# other packages 
using ClimateModels
using NCDatasets</code></pre><p>This loads up DarOneTools, then imports it along with the ClimateModels and NCDatasets packages. You will see these lines of code repeated at the top of every file we work with from here on out! </p><p>Next we have to let  <code>MITgcm_path[1]</code> point to the directory where the Darwin Fortran code lives, establish that we are working with a 1x1 parcel of water (instead of running multiple grid cells at once), and we want to allow all nutrients to freely cycle (intead of holding the concentrations in the water constant). </p><p>Note that if you are not using Docker, you will have to change the <code>MITgcm_path[1] = &quot;directory/to/darwin&quot;</code> line of code to contain the directory in which the Darwin fortran code is. </p><pre><code class="nohighlight hljs"># the path to the Darwin version of the MITgcm
MITgcm_path[1] = &quot;/dar_one_docker/darwin3&quot; # CHANGE ME if not using Docker

nX = 1
nY = 1

# update SIZE.h 
update_grid_size(nX, nY)

# which nutrients can change?
param_list = ones(19) # let all nutrients cycle normally
hold_nutrients_constant(param_list)

build(base_configuration)</code></pre><p>With the <code>build</code> command, we are done with the <code>bottle_experiment_build.jl</code> file! With vim, make sure you are not in insert mode by pressing <code>esc</code> then close the file by typing <code>:q</code> + enter. </p><p>Back in the Docker bash command line, we will run the bottle experiment build file with the command </p><pre><code class="language-bash hljs">julia bottle_experiment_build.jl</code></pre><p>A bunch of info will be printed to the console as the model is building. Just hang tight for a minute or two and wait until you see a &quot;successful build&quot; message. </p><p>Next we will open the bottle experiment run file.</p><pre><code class="language-bash hljs">vim bottle_experiment_run.jl</code></pre><p>We will go through every line of code in this file before we close it and run it from the docker command line. </p><p>Again you will see the lines of code loading and importing DarOneTools and the NCDatasets and ClimateModels packages, along with the line of code that points to the Darwin fortran directory. </p><pre><code class="nohighlight hljs">include(&quot;../src/DarOneTools.jl&quot;)
using .DarOneTools
# other packages 
using ClimateModels
using NCDatasets

# the path to the Darwin version of the MITgcm
MITgcm_path[1] = &quot;/dar_one_docker/darwin3&quot; </code></pre><p>Next, we load up the files using to set initial values for tracers, taken from a surface point in a global MITgcm Darwin run. </p><pre><code class="nohighlight hljs"># load seed files - these are from global darwin runs 
seed_file_3d = &quot;/dar_one_docker/3d.nc&quot;
seed_file_temp = &quot;/dar_one_docker/tave.nc&quot;
seed_file_par = &quot;/dar_one_docker/par.nc&quot;
seed_ds_3d = Dataset(seed_file_3d)
seed_ds_temp = Dataset(seed_file_temp)
seed_ds_par = Dataset(seed_file_par)

# note: these are INDICES not values 
# hawaii ish 
depth = 1
lon = 203
lat = 109
t = 1</code></pre><p>In the code, you will see an additional experiment increasing NH4, which was not discussed in the paper, but provided here as an example. </p><pre><code class="nohighlight hljs">descriptions = [&quot;control&quot;, &quot;with-no3&quot;, &quot;with-nh4&quot;]
for i in 1:3
    # SEE CODE BELOW 
end</code></pre><p>For each experiment, we first set up the config. </p><pre><code class="nohighlight hljs">    # unique name for your run 
    config_id = &quot;bottle-$(descriptions[i])-$lon-$lat&quot; # CHANGE ME
    config_obj, rundir = create_MITgcm_config(config_id)
    setup(config_obj)</code></pre><p>Set the length of the run to be 7 days (each iteration is 3 hours; <code>8 iterations per day * 7 days = 56</code>), writing to diagnostics every 4 hours. </p><pre><code class="nohighlight hljs">    # length of run 
    end_time = 56 # 2880 = one year, in iterations
    update_end_time(config_obj, end_time)

    # output frequency 
    frequency = 43200/3 # 604800 = one week, in seconds; 43200 = 12 hours 
    update_all_diagnostic_freqs(config_obj, frequency)</code></pre><p>Next we set the temperature and the light. </p><pre><code class="nohighlight hljs">    # set temperature from seed file 
    temp = seed_ds_temp[&quot;Ttave&quot;][lon, lat, depth, t]
    update_temperature(config_obj, temp)

    # light 
    light_depth = 4 # deeper into water column
    update_radtrans(config_obj, seed_ds_par, lon, lat, light_depth, t)</code></pre><p>We initialize all of the nutrients and the plankton community from the seed file. </p><pre><code class="nohighlight hljs">    # set nutrients and biomass from seed file 
    nutrients = 1:19 
    pico = 21:24
    cocco = 25:29
    diaz = 30:34
    diatom = 35:43
    mixo_dino = 44:51
    zoo = 52:67
    bacteria = 68:70
    update_tracers(config_obj, nutrients, seed_ds_3d, lon, lat, depth, t)
    update_tracers(config_obj, pico, seed_ds_3d, lon, lat, depth, t)
    update_tracers(config_obj, cocco, seed_ds_3d, lon, lat, depth, t)
    update_tracers(config_obj, diatom, seed_ds_3d, lon, lat, depth, t)
    update_tracers(config_obj, mixo_dino, seed_ds_3d, lon, lat, depth, t)
    update_tracers(config_obj, zoo, seed_ds_3d, lon, lat, depth, t)
    update_tracers(config_obj, bacteria, seed_ds_3d, lon, lat, depth, t)</code></pre><p>For the second iteration, we add extra NO3. For the third, we add extra NH4. Note that here, we are using the &quot;tracer id&quot; to change the nutrients - NO3 is tracer 2, NH4 is tracer 4. You can find a list of all tracers and their corresponding IDs in the <a href="https://barbara42.github.io/Dar_One/build/darwin_background/">darwin background</a> section. </p><pre><code class="nohighlight hljs">    if i == 2
        # add extra NO3
        println(&quot;ADDING no3!!!!!!!!!!&quot;)
        original_no3_val = seed_ds_3d[&quot;TRAC02&quot;][lon, lat, depth, t]
        new_no3_val = original_no3_val*10
        update_tracer(config_obj, 2, new_no3_val)
    end
    if i == 3
        println(&quot;ADDING nh4!!!!!!!!!!&quot;)
        # add extra NH4 
        original_no3_val = seed_ds_3d[&quot;TRAC04&quot;][lon, lat, depth, t]
        new_no3_val = original_no3_val*10
        update_tracer(config_obj, 4, new_no3_val)
    end</code></pre><p>Lastly, we call the run function.</p><pre><code class="nohighlight hljs">dar_one_run(config_obj)</code></pre><p>With the <code>run</code> command, we are done with the <code>bottle_experiment_run.jl</code> file! With vim, make sure you are not in insert mode by pressing <code>esc</code> then close the file by typing <code>:q</code> + enter. </p><p>Back in the Docker bash command line, we will run the bottle experiment run file with the command </p><pre><code class="language-bash hljs">julia bottle_experiment_run.jl</code></pre><p>It will take a few seconds to start up, but eventually you will see output being printed to the console. </p><h2 id="Output"><a class="docs-heading-anchor" href="#Output">Output</a><a id="Output-1"></a><a class="docs-heading-anchor-permalink" href="#Output" title="Permalink"></a></h2><p>The final output will be in netcdf files in the <code>ecco_gud_DATE</code> directory in <code>/dar_one_docker/darwin3/verification/dar_one_config/run/bottle-with-no3-203-109/run</code>. In order to copy it back over to your local machine, you will need to open a terminal on your machine (NOT within the docker container) and use the <code>docker cp</code> command (<code>docker cp container-id:/path/filename.txt ~/Desktop/filename.txt</code>). You can get the container id from the docker command prompt (root@container-id:/dar<em>one</em>docker). </p><p>The <code>3d.0000000000.nc</code> file contains nutrients and plankton abundances, so that&#39;s the one we want for now!</p><pre><code class="nohighlight hljs">docker cp container-id:/dar_one_docker/darwin3/verification/dar_one_config/run/bottle-with-no3-203-109/run/ecco_gud_20230622_0001/3d.0000000000.t001.nc ~/Desktop/</code></pre><p>Now you have a netcdf file on your local machine to explore however you prefer! In depth descriptions of all the output files can be found in <a href="https://barbara42.github.io/Dar_One/build/darwin_background/">Darwin Background</a>.</p><h1 id="Case-Study-B-Global-Steady-State"><a class="docs-heading-anchor" href="#Case-Study-B-Global-Steady-State">Case Study B - Global Steady State</a><a id="Case-Study-B-Global-Steady-State-1"></a><a class="docs-heading-anchor-permalink" href="#Case-Study-B-Global-Steady-State" title="Permalink"></a></h1><h2 id="Overview-2"><a class="docs-heading-anchor" href="#Overview-2">Overview</a><a class="docs-heading-anchor-permalink" href="#Overview-2" title="Permalink"></a></h2><p><img src="../images/Fig_Bray_Curtis.png" alt="steady-state"/></p><p>(A) The average total biomass over the course of a year in the DARWIN model. Parameters from the DARWIN model, such as nutrients, species abundance, sunlight, and temperature, are used to initialize a matrix of DAR1s, shown in (B).  The DAR1 grid is 360x160 large, with each DAR1 &quot;cell&quot; corresponding to a lat/lon point in the DARWIN model. The grid of DAR1s is run 10 years forward, with final &quot;steady state&quot; values calculated from the average of the last two years. (C) shows the Bray-Curtis Dissimilarity index of the steady state community versus the initial community. The steady state is highly dissimilar to DARWIN in regions with high values (yellow), and low valued (blue) indicate areas where the community structure of the two models are comparable.</p><p>See the grid section of the <a href="https://barbara42.github.io/Dar_One/build/beginner_tutorials/">beginner tutorials</a> to learn the details of how to run DAR1 in parallel in this grid format. </p><h2 id="Code-Walkthrough-2"><a class="docs-heading-anchor" href="#Code-Walkthrough-2">Code Walkthrough</a><a class="docs-heading-anchor-permalink" href="#Code-Walkthrough-2" title="Permalink"></a></h2><p>First we will open and examine the <code>global_steadystate_build.jl</code> file. </p><pre><code class="language-bash hljs">vim global_steadystate_build.jl</code></pre><p>Reminder that we are in the <code>/dar_one_docker/Dar_One/case_studies</code> directory.</p><p>The 360 x 160 matrix was divided in 16 parts, each 90 x 40. After running, the 16 tiles were stitched together again. Prior to building, we specify this grid size, and make sure all nutients are allowed to cycle normally (i.e. the available amount in the water is not held constant)</p><pre><code class="nohighlight hljs">include(&quot;../src/DarOneTools.jl&quot;)
using .DarOneTools
using NCDatasets

# set path to MITgcm 
MITgcm_path[1] = &quot;/dar_one_docker/darwin3&quot; # CHANGE ME (unless using docker)

# set up size of your grid
# running the 360x180 world in 16 quadrants in case something goes wrong midway
nX = 90
nY = 40

# update SIZE.h 
update_grid_size(nX, nY)

# which nutrients can change?
param_list = ones(19) # let all nutrients cycle normally
hold_nutrients_constant(param_list)

# BUILD 
build(base_configuration)</code></pre><p>we are done with the <code>global_steadystate_build.jl</code> file! With vim, make sure you are not in insert mode by pressing <code>esc</code> then close the file by typing <code>:q</code> + enter. </p><p>Back in the Docker bash command line, we will run the bottle experiment build file with the command </p><pre><code class="language-bash hljs">julia global_steadystate_build.jl</code></pre><p>A bunch of info will be printed to the console as the model is building. Just hang tight for a minute or two and wait until you see a &quot;successful build&quot; message. </p><p>Next we will open the global steady state run file.</p><pre><code class="language-bash hljs">vim global_steadystate_run.jl</code></pre><p>We will go through every line of code in this file before we close it and run it from the docker command line. </p><p>The yearly averages from a global DARWIN run were used to initialize a grid of DAR1s. Here, we load up those seed files. </p><pre><code class="nohighlight hljs"># load seed files - these are from global darwin runs
# yearly average!  
seed_file_3d = &quot;/Users/birdy/Documents/eaps_research/gcm_analysis/gcm_data/darwin_yearly_avg/3d.nc&quot;
seed_file_temp = &quot;/Users/birdy/Documents/eaps_research/gcm_analysis/gcm_data/darwin_yearly_avg/tave.nc&quot;
seed_file_par = &quot;/Users/birdy/Documents/eaps_research/gcm_analysis/gcm_data/darwin_yearly_avg/par.nc&quot;
seed_ds_3d = Dataset(seed_file_3d)
seed_ds_temp = Dataset(seed_file_temp)
seed_ds_par = Dataset(seed_file_par)
t = 1 # yearly averages, only have one timepoint</code></pre><p>Next, we specify the ranges for breaking down the lat (y) and lon (x) into 4 sections each. </p><pre><code class="nohighlight hljs"># what slice do we want?
# these are INDICES so must be INTEGERS
x_idxs = [(1,90), (91,180), (181, 270), (271,360)]
y_idxs = [(1,40), (41,80), (81, 120), (121, 160)]

for x_idx in x_idxs
    for y_idx in y_idxs
        # SEE CODE BELOW
    end
end</code></pre><p>We initialize values and run the model inside the for loop. All of the following code goes inside that loop! First, we unpack the range values for each quadrant</p><pre><code class="nohighlight hljs">        x = collect(x_idxs[x_idx][1]:x_idxs[x_idx][2])
        y = collect(y_idxs[y_idx][1]:y_idxs[y_idx][2])
        z = 1 # surface </code></pre><p>Then set up the config files as described in the basic beginner tutorial, setting the total amount of time the model will run for to 20 years, writing to diagnostic files every 1 year, and letting the run-time files know the correct grid size.</p><pre><code class="nohighlight hljs">        # set up config 
        config_id = &quot;globe-ss-$x_idx-$y_idx&quot;
        config_obj, rundir = create_MITgcm_config(config_name)
        setup(config_obj)

        # length of run 
        end_time = 2880*20 # 2880 is one year, in iterations
        update_end_time(config_obj, end_time)

        # output frequency 
        frequency = 2592000*12 # 2592000 is one month, in seconds 
        update_all_diagnostic_freqs(config_obj, frequency)

        # update data &gt; PARM04 &gt; delX and delX
        update_delX_delY_for_grid(config_obj, nX, nY) </code></pre><p>Next we initialize all of the tracer values using the seed files, with the exception of diazotrophs which we set to zero. </p><pre><code class="nohighlight hljs">        # create initial bin files for tracers that are not zero
        non_zero_tracers = cat(1:29, 35:70, dims=1)
        for tracer_id in non_zero_tracers
            tracer_name = tracer_id_to_name(tracer_id)
            init_matrix = seed_ds_3d[tracer_name][x, y, z, t]
            init_tracer_grid(config_obj, tracer_name, init_matrix)
        end

        # create initial bin files for tracers that are zero (diazotrophs)
        for tracer_id in [30,31,32,33,34]
            tracer_name = tracer_id_to_name(tracer_id)
            init_matrix = zeros(Float32, nY, nX)
            init_tracer_grid(config_obj, tracer_name, init_matrix)
        end</code></pre><p>Lastly, we set the temperature for each grid cell according to the MITgcm Darwin yearly average, as well as the light. </p><pre><code class="nohighlight hljs">        # create bin file for temperatures - all 15 degrees
        temp_matrix = seed_ds_temp[&quot;Ttave&quot;][x, y, z, t]
        init_temperature_grid(config_obj, temp_matrix)

        # create bin files for light 
        z=3 # lower value for light - farther into the water column
        init_radtrans_grid_xy(config_obj, seed_ds_par, x, y, z, t)</code></pre><p>Finally we can run! </p><pre><code class="nohighlight hljs">        # FINALLY! Run!
        dar_one_run(config_obj)</code></pre><p>With the <code>run</code> function, we are done with the <code>global_steadystate_run.jl</code> file! With vim, make sure you are not in insert mode by pressing <code>esc</code> then close the file by typing <code>:q</code> + enter. </p><p>Back in the Docker bash command line, we will run the bottle experiment run file with the command </p><pre><code class="language-bash hljs">julia global_steadystate_run.jl</code></pre><p>It will take a few seconds to start up, but eventually you will see output being printed to the console. </p><p>The final &quot;steady state&quot; values were calculated by averaging the last 2 years. </p><p>Code to stitch the files together and calculate the bray-curtis dissimilarity score will be coming soon.</p><h1 id="Case-Study-C-Nitrogen-Fixers-Niche"><a class="docs-heading-anchor" href="#Case-Study-C-Nitrogen-Fixers-Niche">Case Study C - Nitrogen Fixers Niche</a><a id="Case-Study-C-Nitrogen-Fixers-Niche-1"></a><a class="docs-heading-anchor-permalink" href="#Case-Study-C-Nitrogen-Fixers-Niche" title="Permalink"></a></h1><p>This is the experiment that inspired the ability to hold the nutients readily available in the water constant because without it nitrogen fixers might flood the system with nitrogen. </p><p><img src="../images/NfixerPhase.png" alt="nitrogen_fixers"/></p><h2 id="Overview-3"><a class="docs-heading-anchor" href="#Overview-3">Overview</a><a class="docs-heading-anchor-permalink" href="#Overview-3" title="Permalink"></a></h2><p>We will run a 30x30 grid of DAR1s each initialized with the same plankton community and nutrients, with the exception of nitrate and phosphate. Nitrate levels in each grid cell will increase along one axis, while phosphate levels will increase along the y-axis. Nutrient values are grabbed from the MITgcm Darwin output, but with iron at 100x and all other nutrients at 10x, and other sources of nitrogen besides NO3 (NO2, NH4, and DON) set to zero. The goal is to flood the system with nutrients, making sure it that nitogen and phosphate are the limiting factors. The simulation is run forward for 5 years with the average of the last year taken to represent the steady state result. </p><h2 id="Code-Walkthrough-3"><a class="docs-heading-anchor" href="#Code-Walkthrough-3">Code Walkthrough</a><a class="docs-heading-anchor-permalink" href="#Code-Walkthrough-3" title="Permalink"></a></h2><p>From the <code>/dar_one_docker/Dar_One/case_studies</code> directory, we can open the nitrogen<em>fixers</em>build.jl file with vim. Because we are changing the number of grid cells we are running, we have to build the model again with these new dimensions. </p><pre><code class="language-bash hljs">vim nitrogen_fixers_build.jl</code></pre><p>You should see the same imports at the top of the file as previously mentioned, in addition to the line <code>MITgcm_path[1] = &quot;/dar_one_docker/darwin3&quot;</code>. (Reminder that you will have to point this to your local directory containing the Darwin code if you are not using the docker.)</p><p>First we update our grid size to be 30x30</p><pre><code class="nohighlight hljs"># set up size of your grid 
nX = 30
nY = 30 
update_grid_size(nX, nY)</code></pre><p>Next, we specify that we want all 19 nutrient tracers to be held constant by passing in a param list of all zeros. If we wanted to allow all nutrients to cycle normally, we would pass in a list of all ones. See the section on constant nutrients in the <a href="https://barbara42.github.io/Dar_One/build/beginner_tutorials/">beginner tutorial</a> page for more information. </p><pre><code class="nohighlight hljs"># which nutrients can change?
param_list = zeros(19) # hold everything constant (0 = constant, 1=cycle)
hold_nutrients_constant(param_list)</code></pre><p>Lastly, we call the build function with the base configuration. </p><pre><code class="nohighlight hljs"># BUILD 
build(base_configuration)</code></pre><p>Now we can close the nitrogen<em>fixers</em>build.jl file. With vim, make sure you are not in insert mode by pressing <code>esc</code> then close the file by typing <code>:q</code> + enter. </p><p>Back in the Docker bash command line, we will run the file with the command </p><pre><code class="language-bash hljs">julia nitrogen_fixers_build.jl</code></pre><p>A bunch of info will be printed to the console as the model is building. Just hang tight for a minute or two and wait until you see a &quot;successful build&quot; message. </p><p>Now we will take a look at the <code>nitrogen_fixers_run.jl</code> file. Open it using the command </p><pre><code class="language-bash hljs">vim nitrogen_fixers_run.jl</code></pre><p>First up in the file is the import statements for Dar1 and other packages. </p><p>Next we do the typical set-up for a DAR1 run - set the path for MITgcm to point to where the MITgcm code is, choose a unique config name for the experiment, and set up the config object. </p><pre><code class="nohighlight hljs"># set path to MITgcm 
MITgcm_path[1] = &quot;/dar_one_docker/darwin3&quot; # CHANGE ME (unless using docker)

# create and set up config 
config_name = &quot;n_30x30&quot;
config_obj, rundir = create_MITgcm_config(config_name)
setup(config_obj)</code></pre><p>After the setup step, we set the time for the simulation to run to be 5 years, in &quot;iteration steps&quot;. (Remember: the MIT Darwin model is set up to step forward 3 hours for each iteration, so we have 8 iterations per day * 360 days = 2880 iterations per year), writing to the diagnostic files every 1 year in seconds. Running for 5 years was chosen by visually looking at longer runs of the same setup and seeing a quasi-steady state reached by that point. We write to only once a year to improve runtime performance, because we are only interested in the average values of the last year. </p><pre><code class="nohighlight hljs"># length of run 
end_time = 2880 * 5 # 2880 = one year, in iterations
update_end_time(config_obj, end_time)

# output frequency 
frequency = 2592000*12 # 2592000 = one month, in seconds
update_all_diagnostic_freqs(config_obj, frequency)</code></pre><p>We then set the entire system to have a constant temperature of 24 degrees C, and update the run-time configuration to have the appropriate grid size. </p><pre><code class="nohighlight hljs">new_temp = 24
update_temperature(config_obj, new_temp)

update_delX_delY_for_grid(config_obj, nX, nY) </code></pre><p>Then the seed files, generated by a global run of MITgcm Darwin, are loaded up to use to set initial values. </p><pre><code class="nohighlight hljs"># seeded from N Pacific gyre 
seed_file = &quot;/dar_one_docker/3d.nc&quot;
seed_ds = Dataset(seed_file)
seed_par_file = &quot;/dar_one_docker/par.nc&quot;
seed_ds_par = Dataset(seed_par_file)
x = 203
y = 135
z= 1
t = 1 # using yearly averages </code></pre><p>Next, we initialize the plankton community, excluding mixotrophic dinoflagellates. Each grid cell starts out with the same quantity of plankton. Reminder that you can see a list of all the plankton tracers, their IDs, and functional groups on the <a href="https://barbara42.github.io/Dar_One/build/darwin_background/">darwin backgroung</a> page. </p><pre><code class="nohighlight hljs"># start with the same plankton community in each cell 
for tracer_id in 21:70
    tracer_name = tracer_id_to_name(tracer_id)
    val = seed_ds[tracer_name][x, y, z, t]
    # no mixotrophic dinoflagellates 
    if 44 &lt;= tracer_id &lt;= 51
        val = 0
    end 
    init_list = repeat([val], nX)
    dim = &quot;x&quot;
    init_tracer_grid(config_obj, tracer_name, init_list, dim, (nX,nY))
end</code></pre><p>The following block of code initializes the nutrients in each grid cell, with the exception of NO3 and PO4, which will be set later. Nutrient values are also grabbed from the MITgcm Darwin output, but with iron at 100x and all other nutrients at 10x, and other sources of nitrogen besides NO3 (NO2, NH4, and DON) set to zero. The goal is to flood the system with nutrients, making sure it that nitogen and phosphate are the limiting factors. </p><pre><code class="nohighlight hljs"># start with the same nutrients in each cell 
for tracer_id in 1:20
    # skip no3 and po4 (2 and 5) - set later 
    if tracer_id == 2 || tracer_id == 5
        continue
    end
    tracer_name = tracer_id_to_name(tracer_id)
    val = seed_ds[tracer_name][x, y, z, t]
    # set NO2, NH4, and DON to 0 (tracers 3, 4, and 9)
    if tracer_id == 3 || tracer_id == 4 || tracer_id == 9
        val = 0.0
    end
    init_list = repeat([val], nX)
    dim = &quot;x&quot;
    # add TONS of iron
    if tracer_id == 6
        init_list = init_list .* 100
    else # also make everything else MORE  
        init_list = init_list .* 10
    end
    init_tracer_grid(config_obj, tracer_name, init_list, dim, (nX,nY))
end</code></pre><p>We then set phosphate values to range from 0 - 0.05 along the y axis, keeping it constant along the x-axis, and nitrate to range from 0 - 0.1 along the x axis. </p><pre><code class="nohighlight hljs"># set increasing phosphate along y axis 
tracer_name = tracer_id_to_name(5)
p_init_list = LinRange(0,0.05, nX)
dim = &quot;y&quot;
init_tracer_grid(config_obj, tracer_name, p_init_list, dim, (nX,nY))

# set increasing nitrate availability along x axis 
tracer_name = tracer_id_to_name(2)
n_init_list = LinRange(0,0.1, nX)
dim = &quot;x&quot;
init_tracer_grid(config_obj, tracer_name, n_init_list, dim, (nX,nY))</code></pre><p>The last step before running is setting the light across the entire grid to a constant value. </p><pre><code class="nohighlight hljs"># Station ALOHA(ish) light 
x = 203
y = 105
z=2 # lower value for light - farther into the water column
update_radtrans(config_obj, seed_ds_par, x, y, z, t)</code></pre><p>Lastly we call the run function, passing it our config object that was created earlier in the file.</p><pre><code class="nohighlight hljs"># FINALLY! Run! 
dar_one_run(config_obj)</code></pre><p>Now we can close that file. With vim, make sure you are not in insert mode by pressing <code>esc</code> then close the file by typing <code>:q</code> + enter. We then run the file using the command </p><pre><code class="language-bash hljs">julia nitrogen_fixers_run.jl</code></pre><p>It will take a few seconds for it to begin running, but you will eventually see a message indicating that the model is running, along with some warnings you can ignore. After a couple minutes, the model with finish with an obvious message saying that the run did not fail!</p><h2 id="Output-2"><a class="docs-heading-anchor" href="#Output-2">Output</a><a class="docs-heading-anchor-permalink" href="#Output-2" title="Permalink"></a></h2><p>The final output will be in the <code>ecco_gud_DATE</code> folder in the directory <code>/dar_one_docker/darwin3/verification/dar_one_config/run/n_30x30/run/</code>. In order to copy it back over to your local machine, you will need to open a terminal on your machine (NOT within the docker container) and use the <code>docker cp</code> command (<code>docker cp container-id:/path/filename.txt ~/Desktop/filename.txt</code>). You can get the container id from the docker command prompt (root@container-id:/dar<em>one</em>docker). </p><p>There is a 3d file created for each year we ran. We are mainly interested in the last 3d file, i.e. the 5th year (3d.0000014400.t001.nc). Here is an example of the full docker copy command. </p><pre><code class="nohighlight hljs">docker cp 631c2b348d93:/dar_one_docker/darwin3/verification/dar_one_config/run/n_30x30/run/ecco_gud_20230602_0001/3d.0000014400.t001.nc ~/Desktop</code></pre><p>Now you have a netcdf file on your local machine to explore however you prefer! In depth descriptions of all the output files can be found in <a href="https://barbara42.github.io/Dar_One/build/darwin_background/">Darwin Background</a>.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../beginner_tutorials/">« Beginner Tutorials</a><a class="docs-footer-nextpage" href="../">Modify Parameters »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Thursday 22 June 2023 12:00">Thursday 22 June 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
